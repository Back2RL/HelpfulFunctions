package SwingExamples;

import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.Container;
import java.awt.Cursor;
import java.awt.Dimension;
import java.awt.EventQueue;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.util.Map;
import java.util.TreeMap;

import javax.swing.BoxLayout;
import javax.swing.JButton;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JPanel;

public class SwingTest extends JFrame {

	/**
	 * 
	 */
	private static final long serialVersionUID = 1L;

	public SwingTest() {

		setTitle("Title");
		setDefaultCloseOperation(EXIT_ON_CLOSE);

		final JLabel yellowLabel = new JLabel("Hello World");
		final JLabel anotherLabel = new JLabel("another");
		yellowLabel.setOpaque(true);
		yellowLabel.setBackground(Color.white);
		yellowLabel.setPreferredSize(new Dimension(200, 80));
		final Container test = new JPanel();
		test.setLayout(new BoxLayout(test, BoxLayout.Y_AXIS));
		getContentPane().add(test, BorderLayout.WEST);

		test.add(yellowLabel, BoxLayout.X_AXIS);
		test.add(anotherLabel, BoxLayout.X_AXIS);
		final JButton button = new JButton("paff");
		getContentPane().add(button, BorderLayout.NORTH);
		final JButton button2 = new JButton("poff");
		getContentPane().add(button2, BorderLayout.EAST);
		final JButton exitButton = new JButton("Close");
		getContentPane().add(exitButton, BorderLayout.SOUTH);

		class MyActionListener implements ActionListener {
			@Override
			public void actionPerformed(final ActionEvent e) {
				yellowLabel.setText(yellowLabel.getText() + " X");
			}
		}
		final MyActionListener listener = new MyActionListener();
		button.addActionListener(listener);
		button2.addActionListener(new ActionListener() {
			private int counter;
			private final Map<Long, Integer> progress = new TreeMap<>();
			private String text;

			synchronized private long createProgressTask(final Thread thread) {
				progress.put(thread.getId(), 0);
				return thread.getId();
			}

			synchronized private int getOverallProgress() {
				int sum = 0;
				final int dividend = progress.size();
				for (final Integer value : progress.values()) {
					sum += value;
				}
				System.out.println(dividend + " sum = " + sum);
				return sum / dividend;
			}

			synchronized private int getProgressTasks() {
				return progress.size();
			}

			synchronized private void setProgress(final long threadID, final int value) {
				progress.replace(threadID, value);
			}

			synchronized private void removeProgressTask(final long threadID) {
				progress.remove(threadID);
			}

			@Override
			public void actionPerformed(final ActionEvent e) {
				final long myID = createProgressTask(Thread.currentThread());
				// button pressed
				// show user that processing occurs
				EventQueue.invokeLater(new Runnable() {
					@Override
					public void run() {
						if (getProgressTasks() == 1) {
							setCursor(new Cursor(Cursor.WAIT_CURSOR));
						}
					}
				});

				// background thread for the heavy duty
				final Thread ht = new Thread() {
					@Override
					synchronized public void run() {
						if (text == null) {
							text = button2.getText();
						}
						// the heavy duty
						final long max = 1_000_000_000L;
						final long showProgress = max / 100;
						for (long i = 0; i < max; ++i) {
							if (i % showProgress == 0L) {
								setProgress(myID, (int) ((i * 100) / max));
								final int currProgress = getOverallProgress();
								EventQueue.invokeLater(new Runnable() {
									@Override
									public void run() {
										button2.setText(text + " (" + currProgress + " %)");
									}
								});
							}

						}

						counter++;
						// end heavy duty
						// new thread to change swing elements, needed for
						// thread-safety
						removeProgressTask(myID);
						EventQueue.invokeLater(new Runnable() {
							@Override
							public void run() {
								button2.setText(text + " " + counter);
								yellowLabel.setText(yellowLabel.getText() + " -");
								if (getProgressTasks() < 1) {
									setCursor(new Cursor(Cursor.DEFAULT_CURSOR));
								}
							}
						});
					}
				};
				ht.start();
			}
		});

		exitButton.addActionListener(new ActionListener() {
			@Override
			public void actionPerformed(final ActionEvent e) {
				System.exit(1);
			}
		});

		pack();
	}

	public static void main(final String[] args) {
		EventQueue.invokeLater(new Runnable() {
			@Override
			public void run() {
				final JFrame f = new SwingTest();
				f.setVisible(true);
				f.setResizable(true);
			}
		});
	}
}
